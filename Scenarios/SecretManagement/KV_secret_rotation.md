# Automatic secret rotation wth Azure Keyvault

using Azure automation Run books, and the Azure powershell framework you can create automated tasks that run on schudle to shuffle the resources keys and store their updated values in key vault.

## Automatioc rotation for Azure resources/services secret rotation

## Azure resources secrets setup:

 1 - Create Azure Automation Account using the azure portal.

 2 - Create or use you existing Azure Key Vault instance.

 3- Give Azure Automation Account an access to the Azure Key Vault.
    
    a - Copy the Azure Active Directory Application and Service Principle generated by Azure Automation from the Automation account "Run as account" blade.
     
![Here](./images/automationAccountADID.png)
    
    b - Go to "Access Policies" section in your Azure Key Vault account, Click on the Add Button and In the Add Access Policy blade click on the Select Principle button and paste in the Name of the Azure AD application name for the Automation Account. Select the application from the list. And Click on Select button. Give Permission to Get, List and Set secrets. Click on Ok and Save buttons to save the access policy.

![Here](./images/KVPolicies.png)

4 - Add Required PowerShell Modules to Azure Automation Account.

    a - In the Azure Automation Accout, Open "Modules Gallery" blade to install  AzureRm.KeyVault, AzureRm.Profile, and AzureRM.Storage modules.

5- Create an Azure Automation Runbook.

    a - In the Azure Automation Account, open "Runbooks" blade and click "Add a runbook".

    b - Add the following code to your runbook and set the values of the Keyvault.

```Powershell
# Required for Azure Automatio Runbook
$azureAutomationConnectionName = "AzureRunAsConnection"

# Get the connection "AzureRunAsConnection
$servicePrincipalConnection = Get-AutomationConnection -Name $azureAutomationConnectionName         

# Adds the Authentication Account
Add-AzureRmAccount -ServicePrincipal -TenantId $servicePrincipalConnection.TenantId -ApplicationId $servicePrincipalConnection.ApplicationId -CertificateThumbprint $servicePrincipalConnection.CertificateThumbprint 

# Set the Variales
$resourceGroup ='YOURSTORAGEACCOUNTRESOURCEGROUPNAME'
$storageAccountName = 'YOURSTORAGEACCOUNTNAME'

$keyVaultName = 'YOURKEYVAULTNAME'
$keyVaultMasterSecretKey = 'StorageAccountPrimaryKey'
$keyVaultSecondarySecretKey = 'StorageAccountSecondaryKey'

# Re-generate the storage account primary key
New-AzureRmStorageAccountKey -ResourceGroupName $resourceGroup -Name $storageAccountName -KeyName "key1"

# Get the newly regenerated Primary Key
$storageAccountMasterKey = (Get-AzureRmStorageAccountKey -ResourceGroupName $resourceGroup -Name $storageAccountName).Value[0]

# Convert the Primary Key to Secure String
$secureValue = ConvertTo-SecureString $storageAccountMasterKey -AsPlainText -Force

# Update the Secret Value in the Key Vault
Set-AzureKeyVaultSecret -VaultName $keyVaultName -Name $keyVaultMasterSecretKey -SecretValue $secureValue

Start-Sleep -s 240

#Re-generate the storage account Secondary Key
New-AzureRmStorageAccountKey -ResourceGroupName $resourceGroup -Name $storageAccountName -KeyName "key2"

# Get the newly regenerated Secondary Key
$storageSecondaryAccountKey = (Get-AzureRmStorageAccountKey -ResourceGroupName $resourceGroup -Name $storageAccountName).Value[1]

# Convert the Primary Key to Secure String
$secureSecondaryValue = ConvertTo-SecureString $storageSecondaryAccountKey -AsPlainText -Force

# Update the Secret Value in the Key Vault
Set-AzureKeyVaultSecret -VaultName $keyVaultName -Name $keyVaultSecondarySecretKey -SecretValue $secureSecondaryValue

```

    c - Click 'Save' runbook then click 'Test Pane' to test your runbook code.

    d - Click 'Publish' to publish the current version of your runbook.

    e - Link the runbook to a schedule using Azure Schduler.

## Automatic rotation for regular secrets

## Regular secrets setup:

 1 - Create Azure Automation Account using the azure portal.

 2 - Create or use you existing Azure Key Vault instance.

 3- Give Azure Automation Account an access to the Azure Key Vault.
    
    a - Copy the Azure Active Directory Application and Service Principle generated by Azure Automation from the Automation account "Run as account" blade.
     
![Here](./images/automationAccountADID.png)
    
    b - Go to "Access Policies" section in your Azure Key Vault account, Click on the Add Button and In the Add Access Policy blade click on the Select Principle button and paste in the Name of the Azure AD application name for the Automation Account. Select the application from the list. And Click on Select button. Give Permission to Get, List and Set secrets. Click on Ok and Save buttons to save the access policy.

![Here](./images/KVPolicies.png)

4 - Add Required PowerShell Modules to Azure Automation Account.

    a - In the Azure Automation Accout, Open "Modules Gallery" blade to install  AzureRm.KeyVault and AzureRm.Profile modules.

5- Create an Azure Automation Runbook.

    a - In the Azure Automation Account, open "Runbooks" blade and click "Add a runbook".

    b - Add the following code to your runbook and set the values of the Keyvault.

```Powershell
# Required for Azure Automatio Runbook 
$azureAutomationConnectionName = "AzureRunAsConnection"

# Get the connection "AzureRunAsConnection
$servicePrincipalConnection = Get-AutomationConnection -Name $azureAutomationConnectionName         
# Adds the Authentication Account
Add-AzureRmAccount -ServicePrincipal -TenantId $servicePrincipalConnection.TenantId -ApplicationId $servicePrincipalConnection.ApplicationId -CertificateThumbprint $servicePrincipalConnection.CertificateThumbprint 

# ------- Required for Azure Automatio Runbook --------- #
$keyVaultName = 'YOURKEYVAULTNAME'
$keyVaultSecret= 'SECRETNAME'
$KeyVaultSecretNewValue= -join ((33..126) | Get-Random -Count 32 | % {[char]$_}) 

#convert the valut to a to secure String
$Secret = ConvertTo-SecureString -String $KeyVaultSecretNewValue -AsPlainText -Force

#Set expiration Date
$Expires = (Get-Date).AddDays(30).ToUniversalTime()

#Set expiration Date
$NBF =(Get-Date).ToUniversalTime()

#set the tags
$Tags = @{ 'Severity' = 'medium'; 'IT' = 'true'}

#set the context type
$ContentType = 'txt'

Set-AzureKeyVaultSecret -VaultName $keyVaultName -Name $keyVaultSecret -SecretValue $Secret -Expires $Expires -NotBefore $NBF -ContentType $ContentType -Tags $Tags

```

    c - Click 'Save' runbook then click 'Test Pane' to test your runbook code.

    d - Click 'Publish' to publish the current version of your runbook.

    e - Link the runbook to a schedule using Azure Schduler.

**Rerernences:**

- [Create Azure Automation account](https://docs.microsoft.com/en-us/azure/automation/automation-quickstart-create-account)

- [Azure Automation Powershell run books](https://docs.microsoft.com/en-us/azure/automation/automation-first-runbook-textual-powershell)
  
- [Azure Powershell SDK](https://docs.microsoft.com/en-us/powershell/module/az.keyvault/set-azkeyvaultsecret?view=azps-2.0.0)

- [Scheduling a runbook in Azure Automation](https://docs.microsoft.com/en-us/azure/automation/shared-resources/schedules)

- [Managing Azure Key Vault using Azure Automation](https://docs.microsoft.com/en-us/azure/key-vault/automation-manage-key-vault)
  
- [Setup key rotation](https://docs.microsoft.com/en-us/azure/key-vault/key-vault-key-rotation-log-monitoring)