# Automating secret rotation wth Azure Keyvault

Using Azure automation Run books, and the Azure powershell framework you can create automated tasks that run on schedule to update a resources secrets/keys and store the updated values in key vault.

## General Azure resources secrets setup

1. [Create an Azure Automation Account using the azure portal](https://docs.microsoft.com/en-us/azure/automation/automation-quickstart-create-account)

2. [Create or use you existing Azure Key Vault instance](https://docs.microsoft.com/en-us/azure/key-vault/quick-create-portal)

3. Grant Azure Automation Account an access to the Azure Key Vault

    - Copy the Azure Active Directory Application and Service Principle generated by Azure Automation from the Automation account "Run as account" blade.

        ![automationAccountADID](./images/automationAccountADID.png)

    - Go to "Access Policies" section in your Azure Key Vault account, Click on the Add Button and In the Add Access Policy blade click on the Select Principle button and paste in the Name of the Azure AD application name for the Automation Account. Select the application from the list. And Click on Select button. Give Permission to Get, List and Set secrets. Click on Ok and Save buttons to save the access policy.

        ![KVPolicies](./images/KVPolicies.png)

## Automatic rotation for Azure resources/services secret rotation

After performing the general steps 1, 2, 3:

- Add Required PowerShell Modules to Azure Automation Account.

  - In the Azure Automation Account, Open "Modules Gallery" blade to install the `AzureRm.Profile`, `AzureRm.KeyVault`, and `AzureRM.Storage` modules.

- Create an Azure Automation Runbook.

  - In the Azure Automation Account, open "Runbooks" blade and click "Add a runbook".

  - Build a script to rotate the primary storage key. You can extract pieces from this script as a reference:

    ```Powershell
    # Required for Azure Automation Runbook
    $azureAutomationConnectionName = "AzureRunAsConnection"

    # Get the connection named by the value of $azureAutomationConnectionName
    $servicePrincipalConnection = Get-AutomationConnection -Name $azureAutomationConnectionName

    # Authenticate using that connection
    Add-AzureRmAccount -ServicePrincipal -TenantId $servicePrincipalConnection.TenantId -ApplicationId $servicePrincipalConnection.ApplicationId -CertificateThumbprint $servicePrincipalConnection.CertificateThumbprint

    # Set the variables
    $resourceGroup ='YOUR_STORAGE_ACCOUNT_RG_NAME'
    $storageAccountName = 'YOUR_STORAGE_ACCOUNT_NAME'
    $keyVaultName = 'YOUR_KEYVAULT_NAME'
    $keyVaultPrimarySecretName = 'NAME_OF_SECRET_TO_STORE_PRIMARY_KEY'
    $keyVaultSecondarySecretName = 'NAME_OF_SECRET_TO_STORE_SECONDARY_KEY'
    $keyVaultPrimaryConnStringSecretName = 'NAME_OF_SECRET_TO_STORE_PRIMARY_CONNECTION_STRING'
    $keyVaultSecondaryConnStringSecretName = 'NAME_OF_SECRET_TO_STORE_SECONDARY_CONNECTION_STRING'

    # Re-generate the storage account primary key and retrieve it
    New-AzureRmStorageAccountKey -ResourceGroupName $resourceGroup -Name $storageAccountName -KeyName "key1"
    $storageAccountMasterKey = (Get-AzureRmStorageAccountKey -ResourceGroupName $resourceGroup -Name $storageAccountName).Value[0]

    # Convert the primary key to PowerShell secure string
    $secureValue = ConvertTo-SecureString $storageAccountMasterKey -AsPlainText -Force

    # Update the primary key secret in the key vault
    Set-AzureKeyVaultSecret -VaultName $keyVaultName -Name $keyVaultPrimarySecretName -SecretValue $secureValue

    # Construct connection string for primary key and store it in key vault
    $masterConnString ="DefaultEndpointsProtocol=https;AccountName="+$storageAccountName+";AccountKey="+$storageAccountMasterKey+";EndpointSuffix=core.windows.net"
    $secureMasterConnString = ConvertTo-SecureString $masterConnString -AsPlainText -Force
    Set-AzureKeyVaultSecret -VaultName $keyVaultName -Name $keyVaultConnStringSecretName -SecretValue $secureMasterConnString

    # TODO:
    # After rotating the primary key, your application will need to somehow start using the updated storage secrets from Key Vault.
    # The sleep is to allow the rotation of the master, and secondary keys without causing a down time to the applications connecting to the storage account, recommended way is to rotate master and secondary keys on differenet schedule.

    # For example, one approach is to build a retry-loop into the storage client in your application to ensure it reloads an
    # updated key from keyvault upon storage connection failure. This would prevent the need to bounce running applications.

    # Otherwise, you'll want to drain connections from an app, restart it to refresh secrets, and then direct traffic at it again
    # (not unlike blue/green)

    # For purposes of this challenge, you would need to restart the app service instead of sleeping below.
    Start-Sleep -s 30

    # Re-generate the storage account secondary key and retrieve it
    New-AzureRmStorageAccountKey -ResourceGroupName $resourceGroup -Name $storageAccountName -KeyName "key2"
    $storageSecondaryAccountKey = (Get-AzureRmStorageAccountKey -ResourceGroupName $resourceGroup -Name $storageAccountName).Value[1]

    # Convert the primary key to PowerShell secure string
    $secureSecondaryValue = ConvertTo-SecureString $storageSecondaryAccountKey -AsPlainText -Force

    # Update the secondary key secret in the Key Vault
    Set-AzureKeyVaultSecret -VaultName $keyVaultName -Name $keyVaultSecondarySecretName -SecretValue $secureSecondaryValue
    ```

  - Click 'Save' runbook then click 'Test Pane' to test your runbook code.

  - Click 'Publish' to publish the current version of your runbook.

  - Link the runbook to a schedule using Azure Schduler.

## Automatic rotation for regular secrets

After performing the general steps 1, 2, 3

- Add Required PowerShell Modules to Azure Automation Account.

  - In the Azure Automation Accout, Open "Modules Gallery" blade to install  AzureRm.KeyVault and AzureRm.Profile modules.

- Create an Azure Automation Runbook.

  - In the Azure Automation Account, open "Runbooks" blade and click "Add a runbook".

  - Add the following code to your runbook and set the values of the Keyvault.

    ```Powershell
    # Required for Azure Automatio Runbook
    $azureAutomationConnectionName = "AzureRunAsConnection"

    # Get the connection "AzureRunAsConnection
    $servicePrincipalConnection = Get-AutomationConnection -Name $azureAutomationConnectionName
    # Adds the Authentication Account
    Add-AzureRmAccount -ServicePrincipal -TenantId $servicePrincipalConnection.TenantId -ApplicationId $servicePrincipalConnection.ApplicationId -CertificateThumbprint $servicePrincipalConnection.CertificateThumbprint

    # ------- Required for Azure Automatio Runbook --------- #
    $keyVaultName = 'YOUR_KEYVAULT_NAME'
    $keyVaultSecretName = 'SECRET_NAME'
    $KeyVaultSecretNewValue= -join ((33..126) | Get-Random -Count 32 | % {[char]$_})

    #convert the valut to a to secure String
    $Secret = ConvertTo-SecureString -String $KeyVaultSecretNewValue -AsPlainText -Force

    #Set expiration Date
    $Expires = (Get-Date).AddDays(30).ToUniversalTime()

    #Set expiration Date
    $NBF =(Get-Date).ToUniversalTime()

    #set the tags
    $Tags = @{ 'Severity' = 'medium'; 'IT' = 'true'}

    #set the context type
    $ContentType = 'txt'

    Set-AzureKeyVaultSecret -VaultName $keyVaultName -Name $keyVaultSecretName -SecretValue $Secret -Expires $Expires -NotBefore $NBF -ContentType $ContentType -Tags $Tags
    ```

  - Click 'Save' runbook then click 'Test Pane' to test your runbook code.

  - Click 'Publish' to publish the current version of your runbook.

  - Link the runbook to a schedule using Azure Schduler.

### References

- [Create Azure Automation account](https://docs.microsoft.com/en-us/azure/automation/automation-quickstart-create-account)

- [Azure Automation Powershell run books](https://docs.microsoft.com/en-us/azure/automation/automation-first-runbook-textual-powershell)

- [Azure Powershell SDK](https://docs.microsoft.com/en-us/powershell/module/az.keyvault/set-azkeyvaultsecret?view=azps-2.0.0)

- [Starting an Azure Automation runbook with a webhook](https://docs.microsoft.com/en-us/azure/automation/automation-webhooks)

- [Create, schedule, and run recurring tasks with the Recurrence trigger in Azure Logic Apps](https://docs.microsoft.com/en-us/azure/connectors/connectors-native-recurrence)

- [Managing Azure Key Vault using Azure Automation](https://docs.microsoft.com/en-us/azure/key-vault/automation-manage-key-vault)

- [Setup key rotation](https://docs.microsoft.com/en-us/azure/key-vault/key-vault-key-rotation-log-monitoring)
